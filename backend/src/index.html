<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Tabelas Dinâmico</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"> <!-- Importa Bootstrap -->
    <script src="/socket.io/socket.io.js"></script> <!-- Importa a biblioteca do Socket.io -->
    <script>
        const socket = io('http://localhost:5001/api'); // Inicializa a conexão com o WebSocket

        // Evento de conexão ao WebSocket
        socket.on('connect', () => {
            console.log('Conectado ao WebSocket');
        });

        // Função para criar tabelas
        async function criarTabela() {
            const senha = document.getElementById('senha').value; // Obtém a senha
            const tabelaInputs = document.querySelectorAll('.tabela-input'); // Seleciona todos os campos de entrada de tabela

            const dados = {};
            tabelaInputs.forEach(input => {
                if (input.value) {
                    dados[`tabela_${input.dataset.index}`] = input.value; // Adiciona as tabelas ao objeto dados
                }
            });

            // Faz a requisição para criar tabelas
            const response = await fetch('http://localhost:5001/api/criarTabelas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ senha, dados }) // Envia a senha e os dados
            });

            const result = await response.text(); // Obtém o resultado da requisição
            console.log(result); // Exibe resultado no console
        }

        // Função para adicionar mais campos de tabela
        function adicionarTabela() {
            const tabelaContainer = document.getElementById('tabelaContainer'); // Obtém o contêiner de tabelas
            const index = tabelaContainer.children.length + 1; // Obtém o índice atual
            const div = document.createElement('div'); // Cria um novo div
            div.classList.add('form-group'); // Adiciona classe de estilo Bootstrap
            div.innerHTML = `
                <label for="tabela_${index}">Nome da Tabela ${index}:</label>
                <input type="text" id="tabela_${index}" class="form-control tabela-input" data-index="${index}" required> <!-- Campo de entrada para a tabela -->
            `;
            tabelaContainer.appendChild(div); // Adiciona o novo campo ao contêiner
        }

        // Função para buscar colunas permitidas
        async function fetchColunasPermitidas() {
            const response = await fetch('http://localhost:5001/api/colunas-permitidas'); // Requisição para buscar colunas permitidas
            
            if (!response.ok) { // Verifica se a resposta é válida
                console.error('Erro ao buscar colunas permitidas:', response.statusText);
                return;
            }

            const colunas = await response.json(); // Converte a resposta em JSON
            const colunasContainer = document.getElementById('colunasPermitidas'); // Obtém o contêiner para as colunas

            // Limpa o contêiner antes de adicionar
            colunasContainer.innerHTML = '';

            // Cria um cartão para as colunas de Chamados
            const chamadoCard = document.createElement('div');
            chamadoCard.classList.add('card', 'mb-3'); // Adiciona classes do Bootstrap
            chamadoCard.innerHTML = `
                <div class="card-header">
                    Colunas Permitidas - Chamados
                </div>
                <ul class="list-group list-group-flush" id="colunasChamados"></ul>
            `;
            colunasContainer.appendChild(chamadoCard); // Adiciona o cartão ao contêiner

            // Adiciona as colunas permitidas de Chamados
            colunas.colunasChamados.forEach(coluna => {
                const li = document.createElement('li');
                li.classList.add('list-group-item'); // Classe para estilizar o item da lista
                li.textContent = coluna; // Define o texto da coluna
                chamadoCard.querySelector('#colunasChamados').appendChild(li); // Adiciona à lista de chamados
            });

            // Cria um cartão para as colunas de AtualizacaoDeDados
            const atualizacaoCard = document.createElement('div');
            atualizacaoCard.classList.add('card', 'mb-3'); // Adiciona classes do Bootstrap
            atualizacaoCard.innerHTML = `
                <div class="card-header">
                    Colunas Permitidas - Atualização de Dados
                </div>
                <ul class="list-group list-group-flush" id="colunasAtualizacao"></ul>
            `;
            colunasContainer.appendChild(atualizacaoCard); // Adiciona o cartão ao contêiner

            // Adiciona as colunas permitidas de AtualizacaoDeDados
            colunas.colunasAtualizacao.forEach(coluna => {
                const li = document.createElement('li');
                li.classList.add('list-group-item'); // Classe para estilizar o item da lista
                li.textContent = coluna; // Define o texto da coluna
                atualizacaoCard.querySelector('#colunasAtualizacao').appendChild(li); // Adiciona à lista de atualização
            });
        }

        // Chama a função ao carregar a página
        window.onload = fetchColunasPermitidas; // Exibe colunas permitidas na inicialização
    </script>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="text-center">Criar Tabelas Dinâmico</h1>
        <form onsubmit="event.preventDefault(); criarTabela();" class="mt-4"> <!-- Previne o envio padrão do formulário -->
            <div class="form-group">
                <label for="senha">Senha:</label>
                <input type="password" id="senha" class="form-control" required> <!-- Campo para senha -->
            </div>

            <div id="tabelaContainer"> <!-- Contêiner para os campos de tabela -->
                <div class="form-group">
                    <label for="tabela_1">Nome da Tabela 1:</label>
                    <input type="text" id="tabela_1" class="form-control tabela-input" data-index="1" required> <!-- Campo para a primeira tabela -->
                </div>
            </div>

            <button type="button" class="btn btn-primary" onclick="adicionarTabela()">Adicionar Tabela</button> <!-- Botão para adicionar mais tabelas -->
            <button type="submit" class="btn btn-success">Criar Tabelas</button> <!-- Botão para enviar o formulário -->
        </form>

        <h2 class="mt-5">Colunas Permitidas:</h2>
        <div id="colunasPermitidas" class="mt-3"></div> <!-- Contêiner para exibir colunas permitidas -->
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script> <!-- jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script> <!-- Popper.js -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> <!-- Bootstrap JS -->
</body>
</html>
